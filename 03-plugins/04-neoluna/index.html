<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>NeoLuna - V2RayGCon手册</title><meta name=generator content="Hugo 0.110.0"><link href=https://vrnobody.github.io/V2RayGConindex.xml rel=alternate type=application/rss+xml><link rel=canonical href=https://vrnobody.github.io/V2RayGCon/03-plugins/04-neoluna/><link rel=stylesheet href=https://vrnobody.github.io/V2RayGCon/css/theme.min.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script>
<link rel=stylesheet href=https://vrnobody.github.io/V2RayGCon/css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script>
<script src=https://vrnobody.github.io/V2RayGCon/js/bundle.js></script><style>:root{}.highlight{line-height:1.1}.highlight div{background-color:#eed!important}.highlight pre{background-color:#eed!important}</style><meta property="og:title" content="NeoLuna"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://vrnobody.github.io/V2RayGCon/03-plugins/04-neoluna/"><meta name=twitter:card content="summary"><meta name=twitter:title content="NeoLuna"><meta name=twitter:description content><meta itemprop=name content="NeoLuna"><meta itemprop=description content></head><body><div class=container><header><h1>V2RayGCon手册</h1><img src=https://img.shields.io/github/release/vrnobody/V2RayGCon.svg alt="Release Badge"></header><div class=content-container><main><h1>NeoLuna</h1><p>V2RayGCon v1.8+</p><p>NeoLuna是采用NeoLua作为后端的Lua脚本管理器。多插个字母n主要是避免c#命名空间重复问题。NeoLua是直接用c#写的lua5.3。原来的Luna插件后端是NLua，它是通过P/Invoke调用c写的lua53.dll。</p><p>使用NeoLua的时候注意这些坑：</p><ol><li>正则是通过简单的查找、替换把lua的pattern转成c#的regex，所以像string.gsub(), string.match()之类的函数，执行结果会和NLua不完全一致。要特别注意参数带table或者function的情况。</li><li>select()是从0开始算，而NLua是从1开始算。</li><li>原版NeoLua的string, table不支持添加函数。NeoLuna插件给他们加了点魔法，让他们支持扩展。副作用是部分函数行为会和NLua不一致。</li><li>require()里面的路径用&rsquo;/&lsquo;分隔，所以NeoLua不能重用NLua写的模块。</li><li>不支持string.dump()，所以用不了thread.lua模块。</li><li>os.time()是带时区的秒数，但os.date()输出结果又和NLua相同。</li><li>io库里面的读、写文件函数有点问题，建议使用std.Sys:Read/Write***()函数。</li></ol><p>既然NeoLua有这么多坑，为什么还要加入这个功能重复的插件呢？因为NLua有个比较严重的问题。当调用像Server:GetAllServers() coreServ:GetCoreStates()这样的函数的时候，NLua会保留一个引用。就算之后删掉服务器、停止脚本、Dispose掉Lua()虚拟机，这个引用仍然存在。这导致CLR没法回收内存。服务器比较少（一千来个）的时候，问题并不严重。但是服务器比较多（上万个）并且经常添加、删除服务器的时候问题就会暴露出来了。有时内存占用会上G。还有个有意思的现象，因为这些对象只保留了一个引用并不会被访问到，所以一段时间（几小时）之后，操作系统会把这些内存转到pagefile（Linux叫swap）里面。这时看任务管理器的内存数值会降下来，给人一种内存被回收了的错觉。而NeoLua的对象完全由CLR的GC管理，没有这个问题。</p><p>上面也提到了，以前Luna插件里面的Misc:Sleep(), Signal:Stop()等等函数，在NeoLuna插件里面统一放到<code>std.</code>里面，也就是变成std.Misc:Sleep(), std.Signal:Stop()等。不过按以前的方式打字就行，自动补全功能会加上<code>std.</code>的。然后调CLR不需要像以前那样import()，NeoLua的CLR库都在<code>clr.</code>里面，不过估计没人用这个功能。NeoLuna可以调用的函数见<a href=https://github.com/vrnobody/V2RayGCon/tree/master/Plugins/NeoLua/Interfaces>Interfaces</a>目录，<code>3rd/neolua</code>目录放了点模块。其他的和Luna插件没多大区别。看<a href=/V2RayGCon/03-plugins/01-luna/>Luna插件的文档</a>就行。</p><p>正则的坑我也没想到好的解决办法。目前一个比较绕的办法是在NeoLua中通过mailbox把要处理的文本发给NLua，处理完成后再发回来。多说一句NeoLua和NLua的LocalStorage, SnapCache还有mailbox都是相通的。但是他们的table实现方式有所不同，所以如果不序列化直接把table当object发送，对方收到的将会是userdata。同一个插件的不同脚本之间发送table就没这个问题。</p><div class=edit-meta>Last updated on 1 Feb 2020<br>Published on 1 Feb 2020<br><a href=03-plugins/04-neoluna/_index.md/edit/master/content/03-plugins/04-neoluna/_index.md class=edit-page><i class="fas fa-pen-square"></i> Edit on GitHub</a></div><nav class=pagination><a class="nav nav-prev" href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/50-all-functions/ title=全部函数><i class="fas fa-arrow-left" aria-hidden=true></i> Prev - 全部函数</a>
<a class="nav nav-next" href=https://vrnobody.github.io/V2RayGCon/03-plugins/04-neoluna/hy2-decoder/ title=导入hy2://...链接>Next - 导入hy2://...链接 <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=open-menu><ul><li><a href=https://vrnobody.github.io/V2RayGCon>Home</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/>使用说明</a><ul class=sub-menu><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/10-set-system-proxy/>TUN和系统代理</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/12-subs-demo/>订阅</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/13-autorun/>开机启动</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/multiple-inst-lnk/>多实例</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/15-custom-inbounds/>导入链接(重要)</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/front-proxy/>前置代理</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/14-update-v2ray-core/>更新core</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/16-share-links/>各种分享链接</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/18-options/>选项</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/01-usage/19-shortcut/>快捷键</a></li></ul></li><li class=parent><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/>插件</a><ul class=sub-menu><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/>Luna</a><ul class=sub-menu><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/02-core-server-events/>监听服务器事件</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/03-input-output-controls-demo/>输入输出控件</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/05-sysapi-demo/>Sys库示例</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/06-clr-lib-demo/>CLR库示例</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/30-internet/>网络相关</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/40-web-ui/>Web UI</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/01-luna/50-all-functions/>全部函数</a></li></ul></li><li class=active><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/04-neoluna/>NeoLuna</a><ul class=sub-menu><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/04-neoluna/hy2-decoder/>导入hy2://...链接</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/04-neoluna/hot-swap-outbounds/>热切换节点</a></li></ul></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/02-pacman/>Pacman</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/03-plugins/03-proxysetter/>ProxySetter</a></li></ul></li><li><a href=https://vrnobody.github.io/V2RayGCon/04-dev/>开发相关</a><ul class=sub-menu><li><a href=https://vrnobody.github.io/V2RayGCon/04-dev/01-release-log/>发布记录</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/04-dev/obsolete-features/>将删除的功能</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/04-dev/02-services-relationship/>各服务调用关系</a></li><li><a href=https://vrnobody.github.io/V2RayGCon/04-dev/03-concepts/>设计理念</a></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>